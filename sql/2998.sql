select * from (select distinct on (c1.id) c1.name, c1.investment, o1.month as month_of_payback, o1.amount_by_month-c1.investment as return from clients as c1, (select o2.client_id, o2.month, (select sum(profit) from operations where month <= o2.month and client_id=o2.client_id) as amount_by_month from operations as o2 group by o2.month, o2.client_id order by o2.client_id, o2.month) as o1 where c1.id=o1.client_id and o1.amount_by_month >= c1.investment group by c1.id, o1.month, o1.amount_by_month order by c1.id, o1.month) as ft order by return DESC;